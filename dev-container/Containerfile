FROM debian:13

# Args
ARG TZ=UTC
ARG DEV_USER=dev
ARG DEV_UID=1000
ARG DEV_GID=1000
ARG HOME_DIR=/home/${DEV_USER}
ARG GIT_DELTA_VERSION=0.18.2

# Env vars
ENV COLORTERM=truecolor \
    EDITOR=nvim \
    LANG=en_US.UTF-8 \
    CLAUDE_CONFIG_DIR="${HOME_DIR}/.claude" \
    LC_ALL=en_US.UTF-8 \
    MAMBA_ROOT_PREFIX=/opt/mamba \
    SHELL=/usr/bin/zsh \
    TERM=tmux-256color \
    TZ="${TZ}" \
    VISUAL=nvim
ENV PATH="${HOME_DIR}/.local/bin:${MAMBA_ROOT_PREFIX}/bin:${PATH}"

# Debian packages
RUN apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y --no-install-recommends \
    aggregate \
    btop \
    build-essential \
    bzip2 \
    ca-certificates \
    cmake \
    curl \
    dnsutils \
    fd-find \
    fontconfig \
    fzf \
    gh \
    git \
    gnupg2 \
    iproute2 \
    ipset \
    iputils-ping \
    jq \
    less \
    libclang-dev \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    locales \
    lsd \
    man-db \
    neovim \
    net-tools \
    netbase \
    netcat-openbsd \
    openssh-client \
    procps \
    ripgrep \
    rsync \
    shfmt \
    sudo \
    traceroute \
    unzip \
    wget \
    zsh \
    && apt-get clean all \
    && apt-get autoremove \
    && rm -rf /var/lib/apt/lists/*

RUN sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen \
    && locale-gen

# Install Git delta
RUN ARCH=$(dpkg --print-architecture) \
    && curl -fsSL -o /tmp/git-delta.deb \
    "https://github.com/dandavison/delta/releases/download/${GIT_DELTA_VERSION}/git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" \
    && dpkg -i /tmp/git-delta.deb \
    && rm /tmp/git-delta.deb

# Create dev user with sudo access
RUN groupadd -g "${DEV_GID}" "${DEV_USER}" \
    && useradd -l -m -u "${DEV_UID}" -g "${DEV_GID}" -d "${HOME_DIR}" -s /usr/bin/zsh "${DEV_USER}" \
    && echo "${DEV_USER}:${DEV_USER}" | chpasswd \
    && usermod -aG sudo "${DEV_USER}"

# Make required directories
RUN mkdir -p \
    "${MAMBA_ROOT_PREFIX}" \
    /work \
    "${HOME_DIR}/.ssh" \
    && chmod 700 "${HOME_DIR}/.ssh" \
    && chown -R "${DEV_USER}:${DEV_USER}" "${MAMBA_ROOT_PREFIX}" /work "${HOME_DIR}"

USER "${DEV_USER}"

# Install micromamba
RUN curl -fsSL https://raw.githubusercontent.com/cameronperot/shell-scripts/refs/heads/master/scripts/install_micromamba.sh | bash
RUN curl -L -o /tmp/environment.yml https://raw.githubusercontent.com/cameronperot/environment-setup/refs/heads/main/environment.yml \
    && micromamba env create -f /tmp/environment.yml \
    && micromamba clean --all --yes \
    && rm /tmp/environment.yml
COPY --chown="${DEV_USER}:${DEV_USER}" ./jupyter_server_config.py "${HOME_DIR}/.jupyter/jupyter_server_config.py"

# Configure dev environment
RUN git clone https://github.com/cameronperot/environment-setup.git /tmp/environment-setup \
    && "${MAMBA_ROOT_PREFIX}/envs/dev/bin/python" /tmp/environment-setup/install.py --neovim-version none \
    && rm -rf "${HOME_DIR}/.config/nvim" \
    && echo "source ${HOME_DIR}/.bash_aliases" >> "${HOME_DIR}/.bashrc"

# Configure root environment
USER root
RUN chown -R root:root /tmp/environment-setup \
    && "${MAMBA_ROOT_PREFIX}/envs/dev/bin/python" /tmp/environment-setup/install.py --neovim-version none \
    && rm -rf "/root/.config/nvim" \
    && rm -rf /tmp/environment-setup \
    && echo "source /root/.bash_aliases" >> /root/.bashrc
USER "${DEV_USER}"

# Install coding agents
RUN curl -fsSL https://claude.ai/install.sh | bash
RUN curl -fsSL https://ampcode.com/install.sh | bash
RUN curl -fsSL https://opencode.ai/install | bash \
    && ln -s "${HOME_DIR}/.opencode/bin/opencode" "${HOME_DIR}/.local/bin/opencode"

# Set the working directory
WORKDIR /work
